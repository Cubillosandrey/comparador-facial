<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparando Rostros...</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; background-color: #f0f2f5; margin: 0; min-height: 100vh; box-sizing: border-box; }
        .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-bottom: 20px; }
        img { max-width: 300px; max-height: 300px; object-fit: cover; border: 4px solid #ccc; border-radius: 12px; background-color: #e9e9e9; }
        #resultado { font-size: 2em; font-weight: bold; margin-top: 20px; padding: 20px; border-radius: 12px; text-align: center; }
        .loading { background-color: #ffc107; color: #333; }
        .success { background-color: #28a745; color: white; }
        .error { background-color: #dc3545; color: white; }
    </style>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>

    <div class="container">
        <img id="img1" src="" alt="Imagen 1">
        <img id="img2" src="" alt="Imagen 2">
    </div>

    <div id="resultado" class="loading">Cargando...</div>

    <script>
        // --- FUNCI√ìN PRINCIPAL QUE SE EJECUTA SOLA ---
        (async () => {
            const img1Element = document.getElementById('img1');
            const img2Element = document.getElementById('img2');
            const resultadoDiv = document.getElementById('resultado');

            // 1. Obtener las URLs de las im√°genes desde los par√°metros de esta p√°gina
            const params = new URLSearchParams(window.location.search);
            const p1 = params.get('p1');
            const p2 = params.get('p2');

            if (!p1 || !p2) {
                resultadoDiv.innerText = "Error: Faltan las URLs de las im√°genes (p1 y p2).";
                resultadoDiv.className = 'error';
                return;
            }

            img1Element.src = p1;
            img2Element.src = p2;

            // 2. Cargar los modelos
            resultadoDiv.innerText = "Cargando modelos... ‚è≥";
            const MODEL_URL = './models';
            try {
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
            } catch (e) {
                resultadoDiv.innerText = "Error al cargar los modelos de IA.";
                resultadoDiv.className = 'error';
                return;
            }

            // 3. Esperar a que las im√°genes se carguen y luego compararlas
            try {
                resultadoDiv.innerText = "Analizando rostros... ü§î";
                const descriptors = await Promise.all([
                    getDescriptor(img1Element),
                    getDescriptor(img2Element)
                ]);

                if (!descriptors[0] || !descriptors[1]) {
                    resultadoDiv.innerText = "No se pudo detectar un rostro en una o ambas im√°genes.";
                    resultadoDiv.className = 'error';
                    return;
                }

                const distancia = faceapi.euclideanDistance(descriptors[0], descriptors[1]);
                const umbral = 0.6;
                
                if (distancia < umbral) {
                    resultadoDiv.innerHTML = `‚úÖ ¬°Son la misma persona!<br><small>(Distancia: ${distancia.toFixed(4)})</small>`;
                    resultadoDiv.className = 'success';
                } else {
                    resultadoDiv.innerHTML = `‚ùå No son la misma persona.<br><small>(Distancia: ${distancia.toFixed(4)})</small>`;
                    resultadoDiv.className = 'error';
                }
            } catch (e) {
                resultadoDiv.innerText = "Error al procesar las im√°genes.";
                resultadoDiv.className = 'error';
                console.error(e);
            }
        })();

        // --- Funci√≥n de ayuda para obtener el descriptor de una imagen ---
        async function getDescriptor(imgElement) {
            // Esperar a que la imagen se cargue completamente
            await new Promise((resolve, reject) => {
                imgElement.onload = resolve;
                imgElement.onerror = reject;
                if (imgElement.complete && imgElement.naturalHeight !== 0) resolve();
            });

            return await faceapi.detectSingleFace(imgElement).withFaceLandmarks().withFaceDescriptor();
        }
    </script>
</body>
</html>
